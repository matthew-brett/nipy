import os
import sys
import tempfile
import subprocess

from bento.commands import hooks

from bento.commands.core \
    import \
        Command

from yaku.conftests \
    import \
        check_compiler

def hack_test():
    # API to get egg filename
    egg = os.path.join("dist", "nipy-0.1.2.dev-py2.6.egg")

    d = tempfile.mkdtemp()
    cmd = ["virtualenv", "-p", sys.executable, d]
    subprocess.check_call(cmd)

    cmd = [os.path.join(d, "bin", "easy_install"), egg]
    subprocess.check_call(cmd)

    oldd = os.getcwd()
    # Go into an arbitrary directory to avoid weird sys.path issues
    newd = tempfile.mkdtemp()
    os.chdir(newd)
    try:
        cmd = [os.path.join(os.path.abspath(d), "bin", "python"), "-c", "'import nipy; nipy.test()'"]
        os.system(" ".join(cmd))
    finally:
        os.chdir(oldd)

class TestCommand(Command):
    long_descr = """\
Purpose: run the test suite
Usage: bentomaker test [OPTIONS]"""
    short_descr = "Run the test suite"

    def run(self, ctx):
        self.set_option_parser()
        o, a = self.parser.parse_args(ctx.cmd_opts)
        if o.help:
            self.parser.print_help()
            return

        hack_test()

@hooks.pre_configure
def pre_configure(ctx):
    cfg = ctx.yaku_configure_ctx
    cfg.load_tool("cython")
    cfg.load_tool("ctasks")


@hooks.post_configure
def myconfigure(ctx):
    if ctx.help:
        return
    from distutils.sysconfig \
        import \
            get_python_inc
    from numpy.distutils.misc_util \
        import \
            get_numpy_include_dirs

    cfg = ctx.yaku_configure_ctx

    if sys.platform == "darwin":
        for arch in ["ppc", "ppc64", "i386", "x86_64"]:
            cfg.env["CFLAGS"].extend(["-arch", arch])
            if not check_compiler(cfg):
                cfg.env["CFLAGS"].pop()
                cfg.env["CFLAGS"].pop()
    cfg.env["CFLAGS"].append("-fPIC")

    cfg.env["CPPPATH"].insert(0, get_python_inc())
    for p in get_numpy_include_dirs():
        cfg.env["PYEXT_CPPPATH"].insert(0, p)
        cfg.env["CPPPATH"].insert(0, p)
    for p in ["wrapper", "fff", "randomkit"]:
        cfg.env["PYEXT_CPPPATH"].append(os.path.join("libcstat", p))
    for p in ["segmentation", "registration"]:
        cfg.env["PYEXT_CPPPATH"].append(os.path.join("nipy", "algorithms", p))
    cfg.env["CYTHON_CPPPATH"].append(os.path.join("libcstat", "wrapper"))

    cfg.env["PYEXT_LIBDIR"].insert(0, cfg.env["BLDDIR"])
    cfg.env["PYEXT_LIBS"].insert(0, "blas")
    cfg.env["PYEXT_LIBS"].insert(0, "lapack")
    cfg.env["PYEXT_LIBS"].insert(0, "cstat")


@hooks.startup
def startup(context):
    context.register_command("test", TestCommand())
